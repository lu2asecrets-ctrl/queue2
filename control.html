<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحة التحكم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .notification {
            animation: slideDown 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <svg class="w-20 h-20 mx-auto text-blue-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                <h2 class="text-3xl font-bold text-gray-800">تسجيل الدخول</h2>
                <p class="text-gray-600 mt-2">اختر العيادة وأدخل كلمة السر</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-bold mb-2">العيادة:</label>
                    <select id="loginClinicSelect" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none text-lg">
                        <option value="">اختر العيادة</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-bold mb-2">كلمة السر:</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none text-lg" placeholder="••••••••">
                </div>
                
                <button onclick="login()" class="w-full bg-blue-600 text-white py-3 rounded-lg text-xl font-bold hover:bg-blue-700 transition-colors">دخول</button>
                
                <a href="index.html" class="block text-center text-gray-600 hover:text-gray-800 mt-4">العودة للصفحة الرئيسية</a>
            </div>
        </div>
    </div>

    <!-- Control Screen -->
    <div id="controlScreen" class="hidden container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white p-6 rounded-lg shadow-lg mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 id="clinicName" class="text-3xl font-bold">عيادة طب الأسرة</h1>
                    <p class="mt-2 text-xl">الرقم الحالي: <span id="currentNumberDisplay" class="text-4xl font-black">0</span></p>
                </div>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-bold">خروج</button>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="hidden notification bg-green-500 text-white p-4 rounded-lg shadow-lg mb-6">
            <div class="flex items-center gap-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
                <span id="notificationText" class="text-xl font-bold"></span>
            </div>
        </div>

        <!-- Main Controls -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <button onclick="nextCustomer()" class="bg-green-600 text-white p-6 rounded-xl shadow-lg hover:bg-green-700 transition-all transform hover:scale-105">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                </svg>
                <span class="text-2xl font-bold">العميل التالي</span>
            </button>

            <button onclick="previousCustomer()" class="bg-blue-600 text-white p-6 rounded-xl shadow-lg hover:bg-blue-700 transition-all transform hover:scale-105">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
                </svg>
                <span class="text-2xl font-bold">العميل السابق</span>
            </button>

            <button onclick="repeatCall()" class="bg-yellow-600 text-white p-6 rounded-xl shadow-lg hover:bg-yellow-700 transition-all transform hover:scale-105">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span class="text-2xl font-bold">تكرار النداء</span>
            </button>

            <button onclick="showCallSpecific()" class="bg-purple-600 text-white p-6 rounded-xl shadow-lg hover:bg-purple-700 transition-all transform hover:scale-105">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                </svg>
                <span class="text-2xl font-bold">نداء رقم معين</span>
            </button>

            <button onclick="showAlertCustomer()" class="bg-indigo-600 text-white p-6 rounded-xl shadow-lg hover:bg-indigo-700 transition-all transform hover:scale-105">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
                <span class="text-2xl font-bold">تنبيه عميل</span>
            </button>

            <button onclick="showDoctorAlert()" class="bg-teal-600 text-white p-6 rounded-xl shadow-lg hover:bg-teal-700 transition-all transform hover:scale-105">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <span class="text-2xl font-bold">تنبيه طبيب</span>
            </button>

            <button onclick="showTransfer()" class="bg-orange-600 text-white p-6 rounded-xl shadow-lg hover:bg-orange-700 transition-all transform hover:scale-105">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                </svg>
                <span class="text-2xl font-bold">تحويل</span>
            </button>

            <button onclick="toggleClinicStatus()" class="bg-gray-600 text-white p-6 rounded-xl shadow-lg hover:bg-gray-700 transition-all transform hover:scale-105">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span id="statusButtonText" class="text-2xl font-bold">إيقاف العيادة</span>
            </button>

            <button onclick="resetClinic()" class="bg-red-600 text-white p-6 rounded-xl shadow-lg hover:bg-red-700 transition-all transform hover:scale-105">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span class="text-2xl font-bold">تصفير العيادة</span>
            </button>
        </div>

        <!-- Emergency Alert -->
        <div class="bg-red-100 border-2 border-red-600 rounded-xl p-6">
            <button onclick="emergencyAlert()" class="w-full bg-red-600 text-white py-4 rounded-lg text-2xl font-bold hover:bg-red-700 flex items-center justify-center gap-4">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                تنبيه طوارئ
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <div id="modalContent" class="space-y-4"></div>
            <div class="flex gap-4 mt-6">
                <button id="modalConfirm" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700">تأكيد</button>
                <button onclick="closeModal()" class="flex-1 bg-gray-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-700">إلغاء</button>
            </div>
        </div>
    </div>
<button onclick="showUrgentCase()" class="bg-red-600 text-white p-6 rounded-xl shadow-lg hover:bg-red-700 transition-all transform hover:scale-105">
    <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
    </svg>
    <span class="text-2xl font-bold">حالة طارئة</span>
</button>

<!-- Urgent Case Modal -->
<div id="urgentCaseModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full mx-4">
        <div class="text-center mb-6">
            <div class="bg-red-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-12 h-12 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-red-600 mb-2">استعجال حالة طارئة ⚠️</h3>
            <p class="text-gray-600">سيتم نقل الحالة إلى أول الطابور وتمييزها بلون أحمر</p>
        </div>

        <div class="space-y-4">
            <!-- Current or New Patient -->
            <div>
                <label class="block text-gray-700 font-bold mb-2">نوع الحالة:</label>
                <div class="flex gap-4">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="urgentType" value="current" class="hidden urgent-type-radio" checked onchange="toggleUrgentFields()">
                        <div class="urgent-type-option border-2 border-red-600 bg-red-50 rounded-lg p-4 text-center">
                            <p class="font-bold text-red-600">مريض موجود</p>
                            <p class="text-sm text-gray-600">له رقم حالياً</p>
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="urgentType" value="new" class="hidden urgent-type-radio" onchange="toggleUrgentFields()">
                        <div class="urgent-type-option border-2 border-gray-300 rounded-lg p-4 text-center hover:border-red-600">
                            <p class="font-bold text-red-600">مريض جديد</p>
                            <p class="text-sm text-gray-600">بدون رقم</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- For Current Patient -->
            <div id="currentPatientSection">
                <label class="block text-gray-700 font-bold mb-2">رقم المريض الحالي:</label>
                <input type="number" id="urgentCurrentNumber" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none text-lg text-center font-bold" placeholder="أدخل الرقم">
            </div>

            <!-- For New Patient -->
            <div id="newPatientSection" class="hidden">
                <label class="block text-gray-700 font-bold mb-2">اسم المريض (اختياري):</label>
                <input type="text" id="urgentPatientName" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none" placeholder="اسم المريض">
            </div>

            <!-- Reason -->
            <div>
                <label class="block text-gray-700 font-bold mb-2">سبب الاستعجال:</label>
                <select id="urgentReason" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                    <option value="حالة طوارئ">حالة طوارئ</option>
                    <option value="إسعاف">إسعاف</option>
                    <option value="حالة حرجة">حالة حرجة</option>
                    <option value="طفل صغير">طفل صغير</option>
                    <option value="مسن">مسن</option>
                    <option value="حامل">سيدة حامل</option>
                    <option value="ذوي احتياجات خاصة">ذوي احتياجات خاصة</option>
                    <option value="أخرى">أخرى</option>
                </select>
            </div>

            <!-- Notes -->
            <div>
                <label class="block text-gray-700 font-bold mb-2">ملاحظات (اختياري):</label>
                <textarea id="urgentNotes" rows="2" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none" placeholder="أي ملاحظات إضافية"></textarea>
            </div>

            <!-- Warning -->
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                <p class="text-sm text-gray-700">
                    <strong>تنبيه:</strong> سيتم تمييز الحالة بلون أحمر في شاشة العرض وستظهر في أعلى الطابور
                </p>
            </div>

            <!-- Buttons -->
            <div class="flex gap-4">
                <button onclick="markAsUrgent()" class="flex-1 bg-red-600 text-white px-6 py-4 rounded-lg font-bold text-lg hover:bg-red-700">
                    ⚠️ تأكيد الاستعجال
                </button>
                <button onclick="closeUrgentModal()" class="flex-1 bg-gray-600 text-white px-6 py-4 rounded-lg font-bold text-lg hover:bg-gray-700">
                    إلغاء
                </button>
            </div>
        </div>
    </div>
</div>

    
    <script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyArFKjBYsFhsPyJPJpjLhH2eSEHlUFEzhI",
  authDomain: "queue-717d5.firebaseapp.com",
  databaseURL: "https://queue-717d5-default-rtdb.firebaseio.com",
  projectId: "queue-717d5",
  storageBucket: "queue-717d5.firebasestorage.app",
  messagingSenderId: "837806460328",
  appId: "1:837806460328:web:f2070b93a2784b1b25619d",
  measurementId: "G-GM30LE46F6"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database(); // Realtime Database
const firestore = firebase.firestore(); // Firestore

        let currentClinicId = null;
        let currentClinic = null;
        let audioPath = 'audio/';
        let speechRate = 1;

        window.onload = function() {
            loadClinicsForLogin();
            loadSettings();
            listenForDoctorAlerts();
        };

        function loadSettings() {
            db.ref('settings').once('value', (snapshot) => {
                const settings = snapshot.val() || {};
                audioPath = settings.audioPath || 'audio/';
                speechRate = settings.speechRate || 1;
            });
        }

        function loadClinicsForLogin() {
            db.ref('clinics').once('value', (snapshot) => {
                const clinics = snapshot.val() || {};
                const select = document.getElementById('loginClinicSelect');
                
                Object.keys(clinics).forEach(id => {
                    const clinic = clinics[id];
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = clinic.name;
                    select.appendChild(option);
                });
            });
        }

        function login() {
            const clinicId = document.getElementById('loginClinicSelect').value;
            const password = document.getElementById('loginPassword').value;

            if (!clinicId || !password) {
                alert('يرجى اختيار العيادة وإدخال كلمة السر');
                return;
            }

            db.ref('clinics/' + clinicId).once('value', (snapshot) => {
                const clinic = snapshot.val();
                if (clinic && clinic.password === password) {
                    currentClinicId = clinicId;
                    currentClinic = clinic;
                    showControlScreen();
                } else {
                    alert('كلمة السر غير صحيحة');
                }
            });
        }

        function showControlScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('controlScreen').classList.remove('hidden');
            document.getElementById('clinicName').textContent = currentClinic.name;
            updateCurrentNumber();
            
            // Listen for changes
            db.ref('clinics/' + currentClinicId).on('value', (snapshot) => {
                currentClinic = snapshot.val();
                updateCurrentNumber();
                updateStatusButton();
            });
        }

        function updateCurrentNumber() {
            document.getElementById('currentNumberDisplay').textContent = currentClinic.currentNumber || 0;
        }

        function updateStatusButton() {
            const btn = document.getElementById('statusButtonText');
            btn.textContent = currentClinic.status === 'active' ? 'إيقاف العيادة' : 'استئناف العيادة';
        }

        function logout() {
            if (confirm('هل تريد الخروج من العيادة؟')) {
                currentClinicId = null;
                currentClinic = null;
                document.getElementById('controlScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginPassword').value = '';
            }
        }

        function nextCustomer() {
            const newNumber = (currentClinic.currentNumber || 0) + 1;
            updateClinicNumber(newNumber);
            makeCall(newNumber);
        }

        function previousCustomer() {
            const newNumber = Math.max((currentClinic.currentNumber || 0) - 1, 0);
            updateClinicNumber(newNumber);
            makeCall(newNumber);
        }

        function repeatCall() {
            makeCall(currentClinic.currentNumber || 0);
        }

        function updateClinicNumber(number) {
            db.ref('clinics/' + currentClinicId).update({
                currentNumber: number,
                lastCall: Date.now()
            });
        }

        function makeCall(number) {
            const callData = {
                clinicId: currentClinicId,
                clinicName: currentClinic.name,
                number: number,
                timestamp: Date.now()
            };

            db.ref('calls').push(callData);
            playCallAudio(number);
            showNotification(`تم نداء العميل رقم ${number}`);
        }

        async function playCallAudio(number) {
            try {
                await playAudio(audioPath + 'ding.mp3');
                await playAudio(audioPath + number + '.mp3');
                await playAudio(audioPath + 'clinic' + currentClinic.number + '.mp3');
            } catch (err) {
                speakText(`على العميل رقم ${number} التوجه إلى ${currentClinic.name}`);
            }
        }

        function playAudio(src) {
            return new Promise((resolve, reject) => {
                const audio = new Audio(src);
                audio.onended = resolve;
                audio.onerror = reject;
                audio.play().catch(reject);
            });
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-SA';
                utterance.rate = speechRate;
                speechSynthesis.speak(utterance);
            }
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            document.getElementById('notificationText').textContent = text;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        function showCallSpecific() {
            showModal('نداء رقم معين', `
                <label class="block text-gray-700 font-bold mb-2">رقم العميل:</label>
                <input type="number" id="specificNumber" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg" placeholder="أدخل الرقم">
            `, () => {
                const number = parseInt(document.getElementById('specificNumber').value);
                if (number) {
                    updateClinicNumber(number);
                    makeCall(number);
                    closeModal();
                }
            });
        }

        function showAlertCustomer() {
            showModal('تنبيه عميل', `
                <label class="block text-gray-700 font-bold mb-2">اسم العميل:</label>
                <input type="text" id="customerName" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg" placeholder="أدخل الاسم">
            `, () => {
                const name = document.getElementById('customerName').value;
                if (name) {
                    const message = `يُرجى من السيد/ة ${name} التوجه إلى ${currentClinic.name}`;
                    db.ref('alerts').push({
                        message: message,
                        timestamp: Date.now()
                    });
                    speakText(message);
                    closeModal();
                }
            });
        }

        function showDoctorAlert() {
            db.ref('clinics').once('value', (snapshot) => {
                const clinics = snapshot.val() || {};
                let options = '<option value="">اختر العيادة</option>';
                Object.keys(clinics).forEach(id => {
                    if (id !== currentClinicId) {
                        options += `<option value="${id}">${clinics[id].name}</option>`;
                    }
                });

                showModal('تنبيه طبيب', `
                    <label class="block text-gray-700 font-bold mb-2">العيادة المستهدفة:</label>
                    <select id="targetClinic" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg mb-4">${options}</select>
                    <label class="block text-gray-700 font-bold mb-2">الرسالة:</label>
                    <input type="text" id="doctorMessage" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg" placeholder="رسالة التنبيه">
                `, () => {
                    const targetId = document.getElementById('targetClinic').value;
                    const message = document.getElementById('doctorMessage').value;
                    if (targetId && message) {
                        db.ref('doctorAlerts').push({
                            fromClinic: currentClinic.name,
                            toClinicId: targetId,
                            message: message,
                            timestamp: Date.now()
                        });
                        closeModal();
                        showNotification('تم إرسال التنبيه');
                    }
                });
            });
        }

        function showTransfer() {
            db.ref('clinics').once('value', (snapshot) => {
                const clinics = snapshot.val() || {};
                let options = '<option value="">اختر العيادة</option>';
                Object.keys(clinics).forEach(id => {
                    if (id !== currentClinicId) {
                        options += `<option value="${id}">${clinics[id].name}</option>`;
                    }
                });

                showModal('تحويل عميل', `
                    <label class="block text-gray-700 font-bold mb-2">رقم العميل:</label>
                    <input type="number" id="transferNumber" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg mb-4" placeholder="رقم العميل">
                    <label class="block text-gray-700 font-bold mb-2">العيادة المستهدفة:</label>
                    <select id="transferClinic" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">${options}</select>
                `, () => {
                    const number = parseInt(document.getElementById('transferNumber').value);
                    const targetId = document.getElementById('transferClinic').value;
                    if (number && targetId) {
                        db.ref('clinics/' + targetId).once('value', (snapshot) => {
                            const targetClinic = snapshot.val();
                            const message = `العميل رقم ${number} محول من ${currentClinic.name} إلى ${targetClinic.name}`;
                            db.ref('alerts').push({
                                message: message,
                                timestamp: Date.now()
                            });
                            speakText(message);
                            closeModal();
                            showNotification('تم التحويل');
                        });
                    }
                });
            });
        }

        function toggleClinicStatus() {
            const newStatus = currentClinic.status === 'active' ? 'paused' : 'active';
            db.ref('clinics/' + currentClinicId + '/status').set(newStatus);
            showNotification(newStatus === 'active' ? 'تم استئناف العيادة' : 'تم إيقاف العيادة');
        }

        function resetClinic() {
            if (confirm('هل تريد تصفير العيادة؟')) {
                db.ref('clinics/' + currentClinicId).update({
                    currentNumber: 0,
                    lastCall: null
                });
                showNotification('تم تصفير العيادة');
            }
        }

        function emergencyAlert() {
            const message = 'تنبيه طوارئ - يُرجى الانتباه';
            db.ref('alerts').push({
                message: message,
                timestamp: Date.now(),
                emergency: true
            });
            speakText(message);
            showNotification('تم إرسال تنبيه الطوارئ');
        }

        function listenForDoctorAlerts() {
            db.ref('doctorAlerts').orderByChild('timestamp').limitToLast(1).on('child_added', (snapshot) => {
                const alert = snapshot.val();
                if (alert.toClinicId === currentClinicId && alert.timestamp > Date.now() - 5000) {
                    showNotification(`تنبيه من ${alert.fromClinic}: ${alert.message}`);
                    speakText(alert.message);
                }
            });
        }

        function listenForControlAlerts() {
            db.ref('controlAlerts').orderByChild('timestamp').limitToLast(1).on('child_added', (snapshot) => {
                const alert = snapshot.val();
                if (alert.clinicId === currentClinicId && alert.timestamp > Date.now() - 5000) {
                    showNotification(`تنبيه من الإدارة: ${alert.message}`);
                    speakText(alert.message);
                    
                    // Show as dialog
                    if (confirm(`تنبيه من الإدارة:\n${alert.message}\n\nهل تريد الاطلاع عليه؟`)) {
                        // User acknowledged
                    }
                }
            });
        }

        function showControlScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('controlScreen').classList.remove('hidden');
            document.getElementById('clinicName').textContent = currentClinic.name;
            updateCurrentNumber();
            
            // Listen for changes
            db.ref('clinics/' + currentClinicId).on('value', (snapshot) => {
                currentClinic = snapshot.val();
                updateCurrentNumber();
                updateStatusButton();
            });
            
            listenForDoctorAlerts();
            listenForControlAlerts();
        }

        function showModal(title, content, onConfirm) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalConfirm').onclick = onConfirm;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }


        document.querySelectorAll('.urgent-type-radio').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('.urgent-type-option').forEach(opt => {
            opt.classList.remove('border-red-600', 'bg-red-50');
            opt.classList.add('border-gray-300');
        });
        if (this.checked) {
            this.nextElementSibling.classList.add('border-red-600', 'bg-red-50');
            this.nextElementSibling.classList.remove('border-gray-300');
        }
    });
});

function showUrgentCase() {
    document.getElementById('urgentCaseModal').classList.remove('hidden');
    document.getElementById('urgentCurrentNumber').value = '';
    document.getElementById('urgentPatientName').value = '';
    document.getElementById('urgentReason').value = 'حالة طوارئ';
    document.getElementById('urgentNotes').value = '';
    toggleUrgentFields();
}

function toggleUrgentFields() {
    const type = document.querySelector('input[name="urgentType"]:checked').value;
    if (type === 'current') {
        document.getElementById('currentPatientSection').classList.remove('hidden');
        document.getElementById('newPatientSection').classList.add('hidden');
    } else {
        document.getElementById('currentPatientSection').classList.add('hidden');
        document.getElementById('newPatientSection').classList.remove('hidden');
    }
}

async function markAsUrgent() {
    const type = document.querySelector('input[name="urgentType"]:checked').value;
    const currentNumber = document.getElementById('urgentCurrentNumber').value;
    const patientName = document.getElementById('urgentPatientName').value;
    const reason = document.getElementById('urgentReason').value;
    const notes = document.getElementById('urgentNotes').value;

    if (type === 'current' && !currentNumber) {
        alert('يرجى إدخال رقم المريض');
        return;
    }

    if (!confirm('هل أنت متأكد من استعجال هذه الحالة؟')) return;

    try {
        let number;
        
        if (type === 'current') {
            // Mark existing number as urgent
            number = parseInt(currentNumber);
        } else {
            // Create new number (1 or next after current)
            const currentClinicNumber = currentClinic.currentNumber || 0;
            number = currentClinicNumber + 1;
            
            // Update clinic current number
            await db.ref('clinics/' + currentClinicId).update({
                currentNumber: number,
                lastCall: Date.now()
            });
        }

        // Create urgent call with special flag
        const urgentData = {
            clinicId: currentClinicId,
            clinicName: currentClinic.name,
            number: number,
            timestamp: Date.now(),
            isUrgent: true,
            urgentReason: reason,
            urgentNotes: notes,
            patientName: patientName || null
        };

        await db.ref('calls').push(urgentData);

        // Also store in Firestore for tracking
        await firestore.collection('urgentCases').add({
            ...urgentData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            handledBy: currentUser?.email || 'unknown'
        });

        // Make the call
        await playCallAudio(number);
        
        // Show notification
        showNotification(`تم استعجال الحالة رقم ${number} - ${reason}`);
        
        closeUrgentModal();
        
        alert('✅ تم استعجال الحالة بنجاح');
    } catch (error) {
        console.error('Error marking urgent:', error);
        alert('خطأ في استعجال الحالة');
    }
}

function closeUrgentModal() {
    document.getElementById('urgentCaseModal').classList.add('hidden');
}
</script>

<!-- 
في display.html، أضف هذا CSS لتمييز الحالات الطارئة
-->
<style>
.urgent-call {
    animation: urgent-pulse 1s infinite;
    border: 3px solid #dc2626 !important;
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
}

@keyframes urgent-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
    50% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
}

.urgent-badge {
    position: absolute;
    top: -10px;
    right: -10px;
    background: #dc2626;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    animation: badge-pulse 1s infinite;
}

@keyframes badge-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
</style>

<!-- 
في display.html في JavaScript، عدل دالة handleCall لتدعم الحالات الطارئة:
-->
<script>
async function handleCall(call) {
    // Highlight clinic card
    const clinicCard = document.getElementById('clinic-' + call.clinicId);
    if (clinicCard) {
        // Add urgent class if it's urgent
        if (call.isUrgent) {
            clinicCard.classList.add('urgent-call');
            
            // Add urgent badge
            if (!clinicCard.querySelector('.urgent-badge')) {
                const badge = document.createElement('div');
                badge.className = 'urgent-badge';
                badge.textContent = '⚠️ طارئ';
                clinicCard.style.position = 'relative';
                clinicCard.appendChild(badge);
            }
            
            // Remove after 10 seconds
            setTimeout(() => {
                clinicCard.classList.remove('urgent-call');
                const badge = clinicCard.querySelector('.urgent-badge');
                if (badge) badge.remove();
            }, 10000);
        } else {
            clinicCard.classList.add('active', 'blink', 'bg-blue-50');
            setTimeout(() => {
                clinicCard.classList.remove('blink');
                setTimeout(() => {
                    clinicCard.classList.remove('active', 'bg-blue-50');
                }, 3000);
            }, 3000);
        }
    }
    
    // Show notification
    let message = `على العميل رقم ${call.number} التوجه إلى ${call.clinicName}`;
    if (call.isUrgent) {
        message = `⚠️ حالة طارئة - ${message}`;
    }
    
    const time = new Date(call.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
    showNotification(message, time);
    
    // Play audio
    await playCallAudio(call.number, call.clinicName);
}

    </script>
</body>
</html>
