<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طباعة التذاكر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .ticket {
                page-break-inside: avoid;
                border: 2px solid #000;
            }
        }
        
        .ticket {
            width: 5cm;
            height: 5cm;
            border: 2px dashed #ccc;
            page-break-inside: avoid;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="no-print bg-gradient-to-r from-purple-600 to-purple-800 text-white p-6 rounded-lg shadow-lg mb-6">
            <h1 class="text-3xl font-bold">طباعة التذاكر</h1>
            <p class="mt-2">اطبع تذاكر المرضى</p>
        </div>

        <!-- Print Settings -->
        <div class="no-print bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">إعدادات الطباعة</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-gray-700 font-bold mb-2">اختر العيادة:</label>
                    <select id="printClinicSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">اختر العيادة</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-bold mb-2">مدة الانتظار التقريبية (دقيقة):</label>
                    <input type="number" id="waitTime" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="5" min="1">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-bold mb-2">من رقم:</label>
                    <input type="number" id="fromNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="1" min="1">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-bold mb-2">إلى رقم:</label>
                    <input type="number" id="toNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="50" min="1">
                </div>
            </div>
            
            <div class="flex gap-4 mt-6">
                <button onclick="generateTickets()" class="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-bold text-lg">إنشاء التذاكر</button>
                <button onclick="window.print()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-bold text-lg">طباعة</button>
                <a href="index.html" class="flex-1 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 font-bold text-lg text-center">العودة</a>
            </div>
        </div>

        <!-- Tickets Preview -->
        <div id="ticketsContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </div>

    <script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyArFKjBYsFhsPyJPJpjLhH2eSEHlUFEzhI",
  authDomain: "queue-717d5.firebaseapp.com",
  projectId: "queue-717d5",
  storageBucket: "queue-717d5.firebasestorage.app",
  messagingSenderId: "837806460328",
  appId: "1:837806460328:web:f2070b93a2784b1b25619d",
  measurementId: "G-GM30LE46F6"
};

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let centerName = 'المركز الطبي';

        window.onload = function() {
            loadClinics();
            loadCenterName();
        };

        function loadCenterName() {
            db.ref('settings/centerName').once('value', (snapshot) => {
                centerName = snapshot.val() || 'المركز الطبي';
            });
        }

        function loadClinics() {
            db.ref('clinics').once('value', (snapshot) => {
                const clinics = snapshot.val() || {};
                const select = document.getElementById('printClinicSelect');
                
                Object.keys(clinics).forEach(id => {
                    const clinic = clinics[id];
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = clinic.name;
                    select.appendChild(option);
                });
            });
        }

        function generateTickets() {
            const clinicId = document.getElementById('printClinicSelect').value;
            const fromNumber = parseInt(document.getElementById('fromNumber').value);
            const toNumber = parseInt(document.getElementById('toNumber').value);
            const waitTime = parseInt(document.getElementById('waitTime').value);

            if (!clinicId) {
                alert('يرجى اختيار العيادة');
                return;
            }

            if (fromNumber > toNumber) {
                alert('رقم البداية يجب أن يكون أقل من رقم النهاية');
                return;
            }

            if (toNumber - fromNumber > 200) {
                alert('العدد الأقصى للتذاكر 200 تذكرة في المرة الواحدة');
                return;
            }

            db.ref('clinics/' + clinicId).once('value', (snapshot) => {
                const clinic = snapshot.val();
                const container = document.getElementById('ticketsContainer');
                container.innerHTML = '';

                const today = new Date();
                const dateStr = today.toLocaleDateString('ar-EG', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

                for (let i = fromNumber; i <= toNumber; i++) {
                    const estimatedWait = (i - fromNumber) * waitTime;
                    const ticket = createTicket(clinic.name, i, dateStr, estimatedWait);
                    container.appendChild(ticket);
                }
            });
        }

        function createTicket(clinicName, number, date, waitTime) {
            const div = document.createElement('div');
            div.className = 'ticket bg-white p-4 flex flex-col items-center justify-center text-center';
            
            const hours = Math.floor(waitTime / 60);
            const minutes = waitTime % 60;
            let waitStr = '';
            if (hours > 0) waitStr += hours + ' ساعة ';
            if (minutes > 0) waitStr += minutes + ' دقيقة';
            if (waitStr === '') waitStr = 'فوري';

            div.innerHTML = `
                <div class="w-full border-b-2 border-dashed border-gray-300 pb-3 mb-3">
                    <h3 class="text-lg font-bold text-gray-800">${centerName}</h3>
                    <p class="text-sm text-gray-600">${clinicName}</p>
                </div>
                
                <div class="mb-3">
                    <p class="text-xs text-gray-500 mb-1">رقم العميل</p>
                    <p class="text-6xl font-black text-blue-600">${number}</p>
                </div>
                
                <div class="w-full border-t-2 border-dashed border-gray-300 pt-3 space-y-1">
                    <p class="text-xs text-gray-600">${date}</p>
                    <p class="text-xs text-gray-600">الانتظار المتوقع: ${waitStr}</p>
                </div>
            `;
            
            return div;
        }
    </script>
</body>
</html>
