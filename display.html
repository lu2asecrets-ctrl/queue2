<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شاشة العرض</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');
        body { font-family: 'Cairo', sans-serif; overflow: hidden; }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .notification-bar {
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .blink {
            animation: blink 1s ease-in-out infinite;
        }
        
        .clinic-card {
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .clinic-card.active {
            border-color: #2563eb;
        }
        
        .clinic-card.paused {
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 h-screen flex flex-col">
    <!-- Top Bar -->
    <div class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white px-6 py-3 flex items-center justify-between shadow-lg">
        <div class="flex items-center gap-4">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
            </svg>
            <h1 id="centerName" class="text-2xl font-bold">المركز الطبي</h1>
        </div>
                    <select id="screenSelect" class="bg-white text-gray-800 px-4 py-2 rounded-lg font-bold">
                <option value="1">الشاشة 1</option>
                <option value="2">الشاشة 2</option>
                <option value="3">الشاشة 3</option>
                <option value="4">الشاشة 4</option>
            </select>
        <div class="flex items-center gap-6">

            <div class="text-right">
                <div id="currentTime" class="text-xl font-bold"></div>
                <div id="currentDate" class="text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Notification Bar -->
    <div id="notificationBar" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="notification-bar bg-gradient-to-r from-green-500 to-emerald-600 text-white px-12 py-8 shadow-2xl rounded-xl max-w-4xl w-full mx-8">
            <div class="flex flex-col items-center gap-6">
                <svg class="w-20 h-20 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
                <div class="text-center">
                    <p id="notificationText" class="text-4xl font-bold mb-3"></p>
                    <p id="notificationTime" class="text-2xl font-bold"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Clinics Column -->
        <div class="w-1/6 p-4 overflow-hidden flex flex-col">
            <div id="clinicsContainer" class="flex-1 space-y-3 overflow-hidden"></div>
            
            <!-- QR Code Card -->
            <div class="bg-white rounded-xl shadow-lg p-4 mt-4">
                <div class="text-center">
                    <p class="text-gray-700 font-bold mb-2">للمتابعة من هاتفك</p>
                    <div class="bg-gray-200 w-32 h-32 mx-auto rounded-lg flex items-center justify-center">
                        <span class="text-gray-500 text-sm">ضع QR Code هنا</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">امسح الكود للدخول</p>
                </div>
            </div>
        </div>

        <!-- Video Player -->
        <div class="flex-1 p-4">
            <div class="bg-black rounded-xl shadow-xl h-full overflow-hidden relative">
                <video id="videoPlayer" class="w-full h-full object-contain" autoplay loop muted playsinline></video>
                <div class="absolute bottom-4 left-4 right-4 flex items-center gap-2 bg-black bg-opacity-50 rounded-lg p-2">
                    <button onclick="togglePlayPause()" class="text-white p-2 hover:bg-white hover:bg-opacity-20 rounded">
                        <svg id="playIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path>
                        </svg>
                        <svg id="pauseIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5 4a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm8 0a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2h-2a2 2 0 01-2-2V4z"></path>
                        </svg>
                    </button>
                    <button onclick="toggleMute()" class="text-white p-2 hover:bg-white hover:bg-opacity-20 rounded">
                        <svg id="muteIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        <svg id="unmuteIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <input type="range" id="volumeSlider" min="0" max="100" value="50" class="flex-1 mx-2" onchange="changeVolume(this.value)">
                    <span class="text-white text-sm" id="volumeDisplay">50%</span>
                </div>
            </div>
        </div>
                <!-- Doctors Sidebar -->
        <div class="w-1/6 p-4 overflow-hidden">
            <div class="bg-white rounded-xl shadow-lg h-full p-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">الأطباء المتواجدون</h3>
                <div id="doctorsContainer" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- Bottom News Ticker -->
    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white py-3 overflow-hidden relative">
        <div id="newsTickerContainer" class="absolute whitespace-nowrap">
            <span id="newsTicker" class="text-xl font-bold px-4 inline-block">مرحباً بكم في المركز الطبي - نتمنى لكم الشفاء العاجل</span>
        </div>
    </div>

    <script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyArFKjBYsFhsPyJPJpjLhH2eSEHlUFEzhI",
  authDomain: "queue-717d5.firebaseapp.com",
  databaseURL: "https://queue-717d5-default-rtdb.firebaseio.com",
  projectId: "queue-717d5",
  storageBucket: "queue-717d5.firebasestorage.app",
  messagingSenderId: "837806460328",
  appId: "1:837806460328:web:f2070b93a2784b1b25619d",
  measurementId: "G-GM30LE46F6"
};

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentScreen = 1;
        let audioPath = 'audio/';
        let videoPath = 'media/';
        let speechRate = 1;
        let alertDuration = 5;
        let videos = [];
        let currentVideoIndex = 0;
        let audioCache = {};
        let videoCache = {};
        let newsTickerInterval;

        window.onload = function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            loadSettings();
            loadClinics();
            listenForCalls();
            listenForAlerts();
            loadVideos();
            
            document.getElementById('screenSelect').addEventListener('change', (e) => {
                currentScreen = parseInt(e.target.value);
                loadClinics();
            });
        };

        function updateDateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dateStr = now.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('currentDate').textContent = dateStr;
        }

        function loadSettings() {
            db.ref('settings').on('value', (snapshot) => {
                const settings = snapshot.val() || {};
                document.getElementById('centerName').textContent = settings.centerName || 'المركز الطبي';
                
                const ticker = document.getElementById('newsTicker');
                ticker.textContent = settings.newsContent || 'مرحباً بكم في المركز الطبي';
                
                // Setup news ticker animation
                const speed = settings.newsSpeed || 50;
                startNewsTicker(speed);
                
                audioPath = settings.audioPath || 'audio/';
                videoPath = settings.videoPath || 'media/';
                speechRate = settings.speechRate || 1;
                alertDuration = settings.alertDuration || 5;
                
                // Preload audio files
                preloadAudio();
            });
        }

        function startNewsTicker(speed) {
            if (newsTickerInterval) clearInterval(newsTickerInterval);
            
            const container = document.getElementById('newsTickerContainer');
            const ticker = document.getElementById('newsTicker');
            const containerWidth = container.parentElement.offsetWidth;
            const tickerWidth = ticker.offsetWidth;
            
            let position = containerWidth;
            container.style.transform = `translateX(${position}px)`;
            
            const pixelsPerSecond = speed;
            const interval = 20; // Update every 20ms
            const pixelsPerInterval = (pixelsPerSecond / 1000) * interval;
            
            newsTickerInterval = setInterval(() => {
                position -= pixelsPerInterval;
                
                if (position < -tickerWidth) {
                    position = containerWidth;
                }
                
                container.style.transform = `translateX(${position}px)`;
            }, interval);
        }

        function loadClinics() {
            db.ref('clinics').on('value', (snapshot) => {
                const clinics = snapshot.val() || {};
                const container = document.getElementById('clinicsContainer');
                container.innerHTML = '';
                
                Object.keys(clinics).forEach(id => {
                    const clinic = clinics[id];
                    // Check if clinic should be displayed on current screen
                    const screens = Array.isArray(clinic.screens) ? clinic.screens : [clinic.screen];
                    if (screens.includes(currentScreen)) {
                        const card = createClinicCard(id, clinic);
                        container.appendChild(card);
                    }
                });
            });
        }

        function createClinicCard(id, clinic) {
            const div = document.createElement('div');
            div.id = 'clinic-' + id;
            const baseClass = 'clinic-card bg-white rounded-xl shadow-lg p-4 border-r-4';
            const statusClass = clinic.status === 'active' ? '' : 'paused';
            div.className = `${baseClass} border-blue-600 ${statusClass}`;
            
            const statusColor = clinic.status === 'active' ? 'text-green-600' : 'text-red-600';
            const statusText = clinic.status === 'active' ? 'نشط' : 'متوقف';
            
            const lastCallTime = clinic.lastCall ? new Date(clinic.lastCall).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '--:--';
            
            div.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-2xl font-bold text-gray-800">${clinic.name}</h3>
                    <span class="text-5xl font-black text-blue-600">${clinic.currentNumber || 0}</span>
                </div>
                <div class="flex items-center justify-between text-sm text-gray-600">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>آخر نداء: ${lastCallTime}</span>
                    </div>
                    <span class="${statusColor} font-bold">${statusText}</span>
                </div>
            `;
            
            return div;
        }

        function listenForCalls() {
            db.ref('calls').orderByChild('timestamp').limitToLast(1).on('child_added', (snapshot) => {
                const call = snapshot.val();
                if (call.timestamp > Date.now() - 5000) {
                    // Check if the clinic is on current screen
                    db.ref('clinics/' + call.clinicId).once('value', (clinicSnapshot) => {
                        const clinic = clinicSnapshot.val();
                        if (clinic) {
                            const screens = Array.isArray(clinic.screens) ? clinic.screens : [clinic.screen];
                            if (screens.includes(currentScreen)) {
                                handleCall(call);
                            }
                        }
                    });
                }
            });
        }

        function listenForAlerts() {
            db.ref('alerts').orderByChild('timestamp').limitToLast(1).on('child_added', (snapshot) => {
                const alert = snapshot.val();
                if (alert.timestamp > Date.now() - 5000) {
                    showNotification(alert.message, new Date(alert.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }));
                }
            });
        }

        async function handleCall(call) {
            // Highlight clinic card
            const clinicCard = document.getElementById('clinic-' + call.clinicId);
            if (clinicCard) {
                clinicCard.classList.add('active', 'blink', 'bg-blue-50');
                setTimeout(() => {
                    clinicCard.classList.remove('blink');
                    setTimeout(() => {
                        clinicCard.classList.remove('active', 'bg-blue-50');
                    }, 3000);
                }, 3000);
            }
            
            // Show notification
            const message = `على العميل رقم ${call.number} التوجه إلى ${call.clinicName}`;
            const time = new Date(call.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            showNotification(message, time);
            
            // Play audio
            await playCallAudio(call.number, call.clinicName);
        }

        function showNotification(text, time) {
            const bar = document.getElementById('notificationBar');
            document.getElementById('notificationText').textContent = text;
            document.getElementById('notificationTime').textContent = time;
            
            bar.classList.remove('hidden');
            
            setTimeout(() => {
                bar.classList.add('hidden');
            }, alertDuration * 1000);
        }

        async function playCallAudio(number, clinicName) {
            try {
                // Play ding
                await playAudio(audioPath + 'ding.mp3');
                
                // Play number
                await playAudio(audioPath + number + '.mp3');
                
                // Try to find clinic audio
                db.ref('clinics').once('value', (snapshot) => {
                    const clinics = snapshot.val() || {};
                    const clinic = Object.values(clinics).find(c => c.name === clinicName);
                    if (clinic) {
                        playAudio(audioPath + 'clinic' + clinic.number + '.mp3').catch(() => {
                            speakText(`التوجه إلى ${clinicName}`);
                        });
                    }
                });
            } catch (err) {
                console.log('Audio file not found, using TTS');
                speakText(`على العميل رقم ${number} التوجه إلى ${clinicName}`);
            }
        }

        function playAudio(src) {
            return new Promise((resolve, reject) => {
                const audio = new Audio(src);
                audio.onended = resolve;
                audio.onerror = reject;
                audio.play().catch(reject);
            });
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-SA';
                utterance.rate = speechRate;
                speechSynthesis.speak(utterance);
            }
        }

        function loadVideos() {
            db.ref('settings').once('value', (snapshot) => {
                const settings = snapshot.val() || {};
                const useLocal = settings.useLocalVideos || false;
                const localPath = settings.localVideoPath || '/sdcard/Videos/';
                const videoList = settings.videoList || ['video1.mp4', 'video2.mp4', 'video3.mp4'];
                
                videos = videoList.map(v => {
                    if (useLocal) {
                        return localPath + v;
                    } else {
                        return videoPath + v;
                    }
                });
                
                const video = document.getElementById('videoPlayer');
                
                if (videos.length > 0) {
                    video.src = videos[0];
                    video.volume = 0.5;
                    
                    video.addEventListener('ended', () => {
                        currentVideoIndex = (currentVideoIndex + 1) % videos.length;
                        video.src = videos[currentVideoIndex];
                        video.play();
                    });
                    
                    video.addEventListener('error', () => {
                        console.log('Error loading video:', videos[currentVideoIndex]);
                        currentVideoIndex = (currentVideoIndex + 1) % videos.length;
                        if (currentVideoIndex < videos.length) {
                            video.src = videos[currentVideoIndex];
                            video.play();
                        }
                    });
                    
                    video.play().catch(err => console.log('Autoplay prevented:', err));
                }
            });
        }

        function togglePlayPause() {
            const video = document.getElementById('videoPlayer');
            const playIcon = document.getElementById('playIcon');
            const pauseIcon = document.getElementById('pauseIcon');
            
            if (video.paused) {
                video.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            } else {
                video.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            }
        }

        function toggleMute() {
            const video = document.getElementById('videoPlayer');
            const muteIcon = document.getElementById('muteIcon');
            const unmuteIcon = document.getElementById('unmuteIcon');
            
            video.muted = !video.muted;
            
            if (video.muted) {
                muteIcon.classList.remove('hidden');
                unmuteIcon.classList.add('hidden');
            } else {
                muteIcon.classList.add('hidden');
                unmuteIcon.classList.remove('hidden');
            }
        }

        function changeVolume(value) {
            const video = document.getElementById('videoPlayer');
            video.volume = value / 100;
            video.muted = false;
            document.getElementById('volumeDisplay').textContent = value + '%';
            
            const muteIcon = document.getElementById('muteIcon');
            const unmuteIcon = document.getElementById('unmuteIcon');
            muteIcon.classList.add('hidden');
            unmuteIcon.classList.remove('hidden');
        }

        function preloadAudio() {
            // Preload common audio files
            const commonFiles = ['ding.mp3'];
            for (let i = 1; i <= 100; i++) {
                commonFiles.push(i + '.mp3');
            }
            for (let i = 1; i <= 20; i++) {
                commonFiles.push('clinic' + i + '.mp3');
            }
            
            commonFiles.forEach(file => {
                const audio = new Audio(audioPath + file);
                audio.preload = 'auto';
                audioCache[file] = audio;
            });
        }

        function playAudio(src) {
            return new Promise((resolve, reject) => {
                const filename = src.split('/').pop();
                let audio;
                
                if (audioCache[filename]) {
                    audio = audioCache[filename].cloneNode();
                } else {
                    audio = new Audio(src);
                }
                
                audio.onended = resolve;
                audio.onerror = reject;
                audio.play().catch(reject);
            });
        }
    </script>
</body>
</html>
